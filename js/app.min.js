steem.api.setOptions({url:"wss://testnet.steem.vc"}),steem.config.set("address_prefix","STX"),steem.config.set("chain_id","79276aea5d4877d9a25892eaa01b0adf019d3e5cb12a97478df3298ccdd01673");var transaction={};function getAgents(){$.getJSON("agents.json",function(e){var a=e.map(function(e){return e.name});steem.api.getAccounts(a,function(a,t){a||$.each(t,function(a,t){$("#agent").append('<option value="'+t.name+'" data-fee="'+e[a].fee+'">'+t.name+" ("+calcRep(t.reputation)+") Fee: "+e[a].fee+"</option>")})})})}function calcRep(e){return(Math.max(Math.log10(Math.abs(parseInt(e)))-9,0)*(parseInt(e)>0?1:-1)*9+25).toFixed(1)}function niceDate(e){return new Date(e+"Z").toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}function getUrlParam(e){var a=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(window.location.href);return a&&a[1]||void 0}if(getAgents(),$("#agent").change(function(e){$("#fee").val($("#agent option:selected").data("fee"))}),$("#escrowTransfer").submit(function(e){var a=$("#sender").val(),t=$("#recipient").val(),o=$("#active_key").val(),r=$("#agent").val(),n=parseInt(89999999*Math.random()+1e7),s="0.000 SBD",i="0.000 STEEM",c=parseFloat($("#amount").val()).toFixed(3),d=$("#currency option:selected").val(),p=parseFloat($("#fee").val()).toFixed(3)+" "+d,l=JSON.stringify({terms:$("#terms").val()});"STEEM"==d?i=c+" "+d:s=c+" "+d,steem.api.getDynamicGlobalProperties(function(e,c){var d=new Date(c.time+"Z");d.setMinutes(d.getMinutes()+60*parseInt($("#deadline").val())-1);var m=new Date(c.time+"Z");m.setHours(m.getHours()+parseInt($("#expiration").val())),steem.broadcast.escrowTransfer(o,a,t,r,n,s,i,p,d,m,l,function(e,t){if(!e&&t.ref_block_num){var o=window.location.href+"?escrowId="+n+"&sender="+a;$("#alert").addClass("alert-success").append("Escrow request has be created successfully. ID:"+n+'<br>Control Panel URL: <a href="'+o+'">'+o+"</a><br>Send this link to receiver and escrow agent for their approval.").fadeIn()}else console.log(e),void 0!==e.payload?$("#alert").addClass("alert-danger").append(e.payload.error.message.replace(/([^>])\n/g,"$1<br><br>")).fadeIn():$("#alert").addClass("alert-danger").append(e).fadeIn()})}),e.preventDefault()}),void 0===getUrlParam("escrowId"))$("#escrowTransfer").removeClass("hidden").fadeIn("slow");else{var escrowId=getUrlParam("escrowId"),sender=getUrlParam("sender");Math.floor(escrowId)==escrowId&&$.isNumeric(escrowId)&&steem.api.getEscrow(sender,escrowId,function(e,a){if(a){$("#escrowControlPanel").removeClass("hidden").fadeIn("slow");var t=a.escrow_id,o=a.agent,r=a.agent_approved;disputed=a.disputed,escrow_expiration=a.escrow_expiration,from=a.from,id=a.id,pending_fee=a.pending_fee,ratification_deadline=a.ratification_deadline,sbd_balance=a.sbd_balance,steem_balance=a.steem_balance,to=a.to,to_approved=a.to_approved,escrow_status="",escrow_amount="",escrow_terms="",steem.api.getAccountHistory(from,-1,100,function(e,a){!e&&a.length&&($.each(a,function(e,a){"escrow_transfer"==a[1].op[0]&&parseInt(a[1].op[1].escrow_id)==parseInt(t)&&(escrow_terms=$.parseJSON(a[1].op[1].json_meta))}),$("#escrow_terms").html(void 0!==escrow_terms.terms?escrow_terms.terms:JSON.stringify(escrow_terms)))}),"0.000 SBD"!==sbd_balance?escrow_amount=sbd_balance:escrow_amount=steem_balance,$("#receiverApprove").data({user:to,action:"approval",approve:1}),$("#receiverDisapprove").data({user:to,action:"approval",approve:0}),$("#agentApprove").data({user:o,action:"approval",approve:1}),$("#agentDisapprove").data({user:o,action:"approval",approve:0}),$("#senderDispute").data({user:from,action:"dispute",dispute:1}),$("#receiverDispute").data({user:to,action:"dispute",dispute:1}),$("#senderRelease").data({user:from,action:"release",release:to}),$("#receiverRelease").data({user:to,action:"release",release:from}),$("#agentRelease").data({user:o,action:"agent_release",from:from,to:to}),$("#receiverApprove, #receiverDisapprove, #agentApprove, #agentDisapprove, #agentRelease, #senderRelease, #receiverRelease, #senderDispute, #receiverDispute").hide();var n="",s="",i="";steem.api.getDynamicGlobalProperties(function(e,a){var t=new Date(escrow_expiration+"Z");r||to_approved?r&&!to_approved?($("#receiverApprove, #receiverDisapprove").show(),n="No action needed.",i="No action needed.",escrow_status="Waiting for recipient's approval."):!r&&to_approved?($("#agentApprove, #agentDisapprove").show(),escrow_status="Waiting for agent's approval.",n="No action needed.",s="No action needed."):disputed?($("#agentRelease").show(),escrow_status="Transaction has been disputed.",n="No action needed. Wait for agent to make decision.",s="No action needed. Wait for agent to make decision."):t<a.time?($("#senderRelease, #receiverRelease").show(),escrow_status="Escrow has been expired.",i="No action needed."):($("#senderDispute, #receiverDispute, #senderRelease, #receiverRelease").show(),escrow_status="Transaction has been approved.",i="No action needed."):($("#receiverApprove, #receiverDisapprove, #agentApprove, #agentDisapprove").show(),escrow_status="Waiting for agent and recipient's approval.",n="No action needed."),$("#sender_action").text(n),$("#receiver_action").text(s),$("#agent_action").text(i),$("#escrow_status").text(escrow_status),$("#blockchain_date").text(niceDate(a.time))}),$("#escrow_id").text(t),$("#escrow_amount").text(escrow_amount),$("#agent_fee").text(pending_fee),$("#approval_deadline").text(niceDate(ratification_deadline)),$("#expiration_date").text(niceDate(escrow_expiration)),$("#sender_name").append('<a href="https://steemit.com/@'+from+'">@'+from+"</a>"),$("#receiver_name").append('<a href="https://steemit.com/@'+to+'">@'+to+"</a>"),$("#agent_name").append('<a href="https://steemit.com/@'+o+'">@'+o+"</a>"),transaction.submitApprove=function(e,a,r,n){steem.broadcast.escrowApprove(a,from,to,o,e,t,r,function(e,a){n()})},transaction.submitRelease=function(e,a,r){steem.broadcast.escrowRelease(a,from,to,o,e,e==from?to:from,t,sbd_balance,steem_balance,function(e,a){r()})},transaction.submitExpired=function(e,a,r){steem.broadcast.escrowRelease(a,from,to,o,e,e==from?from:to,t,sbd_balance,steem_balance,function(e,a){r()})},transaction.submitDispute=function(e,a,r){steem.broadcast.escrowDispute(a,from,to,o,e,t,function(e,a){r()})},transaction.submitEscrow=function(e,a,r,n){steem.broadcast.escrowRelease(a,from,to,o,e,r,t,sbd_balance,steem_balance,function(e,a){n()})}}else e&&console.log(e),$("#alert").addClass("alert-warning").append("There was a problem loading the transaction. Either it doesn't exists or completed or receiver or agent hadn't approved the transaction. Please contact other parties and create a new transaction.")})}$("#actionForm").submit(function(e){e.preventDefault();var a=$("#user").val(),t=$("#wif").val(),o=$("#action").val(),r=$("#action_value").val(),n=$("#release_to").val();"approval"===o?typeof(r=Boolean(Number(r)))==typeof!0&&transaction.submitApprove(a,t,r,function(e,a){$("#actionMdal").modal("hide"),location.reload()}):"dispute"===o?transaction.submitDispute(a,t,function(e,a){$("#actionMdal").modal("hide"),location.reload()}):"release"===o?transaction.submitRelease(a,t,function(e,a){$("#actionMdal").modal("hide"),location.reload()}):"agent_release"===o&&transaction.submitEscrow(a,t,n,function(e,a){$("#actionMdal").modal("hide"),location.reload()})});